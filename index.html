<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>지진 데이터 시각화</title>

  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    /* (1) body 전체를 Flex 컨테이너로 만들고,
         화면 세로 중앙 정렬은 필요 없다면 justify-content를 지워도 됩니다. */
    html, body {
      margin: 0;
      padding: 0;
      background-color: #eef2f5;
      display: flex;
      flex-direction: column;
      align-items: center;     /* 가로 방향 중앙 정렬 */
      /* justify-content: center; */ /* 세로 방향 중앙 정렬이 필요하다면 주석 해제 */
    }

    /* (2) 지도와 컨트롤 박스를 묶는 래퍼(wrapper) */
    .wrapper {
      width: 900px;         /* 지도의 width와 동일하게 맞춤 */
      margin: 20px auto;      /* 화면 상하 여백 20px, 좌우 자동 마진(가운데 배치) */
      display: flex;
      flex-direction: column; /* 위에 높이가 있는 지도, 아래에 컨트롤 박스 */
      align-items: stretch;   /* 자식 요소(#vis, .controls)가 너비 100%로 늘어나도록 */
      gap: 0;                 /* 필요 시 하단 여백을 조정하되, 여기서는 0 */
    }

    /* (3) Vega 시각화 영역(#vis) */
    #vis {
      width: 100%;            /* 래퍼 너비(900px)에 맞춰 100% */
      height: 550px;          /* 지도 높이 고정 */
      background: white;      /* 약간의 흰색 배경 */
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: grab; /* 마우스 커서를 잡는 모양으로 변경 */
    }
    #vis:active {
        cursor: grabbing; /* 드래그 중에는 주먹 쥔 모양으로 변경 */
    }

    /* (4) 컨트롤 박스(.controls) 스타일 */
    .controls {
      width: 100%;            /* 래퍼 너비(900px)에 딱 맞춤 */
      background: white;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 12px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 4px;
      margin-top: 16px;       /* 지도와 컨트롤 사이 약간의 여백 */
    }

    .controls > div {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .controls label {
      font-size: 14px;
      white-space: nowrap;
    }

    .controls input[type="text"] {
      width: 180px;
      padding: 4px 6px;
      font-size: 14px;
    }

    .controls input[type="range"] {
      width: 150px;
    }

    .controls input[type="date"] {
      padding: 4px;
      font-size: 14px;
    }

    .controls span {
      font-size: 14px;
      min-width: 24px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div id="vis"></div>

    <div class="controls">
      <div>
        <label for="searchTerm">위치 검색</label>
        <input type="text" id="searchTerm" placeholder="예: 일본" />
      </div>
      <div>
        <label for="minMag">최소 규모</label>
        <input type="range" id="minMag" min="0" max="10" step="0.1" value="0" />
        <span id="minMagValue">0</span>
      </div>
      <div>
        <label for="maxMag">최대 규모</label>
        <input type="range" id="maxMag" min="0" max="10" step="0.1" value="10" />
        <span id="maxMagValue">10</span>
      </div>
      <div>
        <label for="startDate">시작 날짜</label>
        <input type="date" id="startDate" />
      </div>
      <div>
        <label for="endDate">종료 날짜</label>
        <input type="date" id="endDate" />
      </div>
    </div>
  </div>

  <script>
    // Vega 사양(spec)
    const spec = {
      "$schema": "https://vega.github.io/schema/vega/v5.json",
      "width": 900,
      "height": 550,
      "padding": 5,
      "background": "steelblue",

      "signals": [
        // --- 데이터 필터링을 위한 신호 ---
        { "name": "searchTerm", "value": "", "on": [{"events": "input#searchTerm", "update": "event.target.value"}] },
        {"name": "minMag", "value": 0, "bind": {"input": "range", "element": "#minMag", "min": 0, "max": 10, "step": 0.1}},
        {"name": "maxMag", "value": 10, "bind": {"input": "range", "element": "#maxMag", "min": 0, "max": 10, "step": 0.1}},
        {"name": "startDate", "value": "", "on": [{"events": "input#startDate", "update": "event.target.value"}]},
        {"name": "endDate", "value": "", "on": [{"events": "input#endDate", "update": "event.target.value"}]},

        // --- 마우스 드래그(PAN)를 위한 신호 ---
        {
          "name": "centerPoint", "value": [0, 0],
          "on": [{
            "events": "[mousedown, window:mouseup] > window:mousemove!",
            "update": "[drag_center[0] + (anchor_geo[0] - invert('world_projection', xy())[0]), drag_center[1] + (anchor_geo[1] - invert('world_projection', xy())[1])]"
          }]
        },
        {"name": "anchor_geo", "value": [0, 0], "on": [{"events": "mousedown", "update": "invert('world_projection', xy())"}]},
        {"name": "drag_center", "value": [0, 0], "on": [{"events": "mousedown", "update": "centerPoint"}]},

        // --- 마우스 휠(ZOOM)을 위한 신호 ---
        {
          "name": "scale", "value": 180,
          "on": [{
            "events": "wheel!",
            "update": "clamp(scale * pow(1.0005, -event.deltaY), 180, 8000)"
          }]
        }
      ],

      "projections": [
        {
          "name": "world_projection",
          "type": "equalEarth",
          "scale": {"signal": "scale"},
          "rotate": {"signal": "[-(centerPoint[0] || 0), -(centerPoint[1] || 0), 0]"},
          "translate": [{"signal": "width / 2"}, {"signal": "height / 2"}]
        }
      ],

      "data": [
        { "name": "world", "url": "https://vega.github.io/vega/data/world-110m.json", "format": { "type": "topojson", "feature": "countries" }},
        {
          "name": "earthquakes",
          "url": "https://raw.githubusercontent.com/Rhamee/Information-Visualization-Final/main/earthquake_data.json",
          "format": { "type": "json" },
          "transform": [
            {
              "type": "filter",
              "expr": "(searchTerm == '' || indexof(lower(datum.location), lower(searchTerm)) >= 0) && (datum.magnitude >= minMag && datum.magnitude <= maxMag) && (startDate == '' || datum.date >= startDate) && (endDate == '' || datum.date <= endDate)"
            },
            // ✨ geopoint 변환을 제거! 좌표는 마크에서 직접 계산합니다.
            { "type": "formula", "expr": "pow(datum.magnitude, 3.5)", "as": "area" }
          ]
        }
      ],

      "marks": [
        {
          "type": "shape",
          "from": { "data": "world" },
          "encode": { "enter": { "fill": { "value": "seagreen" }, "stroke": { "value": "#666" } } },
          "transform": [{ "type": "geoshape", "projection": "world_projection" }]
        },
        {
          "type": "symbol",
          "from": { "data": "earthquakes" },
          // ✨ encode를 enter와 update로 분리하여 동적/정적 속성을 관리합니다.
          "encode": {
            "enter": {
              // 한 번만 계산하면 되는 정적 속성들
              "size": { "field": "area" },
              "fill": { "value": "orange" },
              "stroke": { "value": "orange" },
              "strokeWidth": { "value": 1 },
              "opacity": { "value": 0.6 },
              "tooltip": { "signal": "'📍 ' + datum.location + '\\n규모: ' + datum.magnitude + ' / ' + datum.date" }
            },
            "update": {
              // 지도가 움직일 때마다 다시 계산해야 하는 동적 속성들
              "x": { "signal": "project('world_projection', datum)[0]" },
              "y": { "signal": "project('world_projection', datum)[1]" }
            }
          }
        }
      ]
    };

    // Vega-Embed를 통해 #vis에 spec 렌더링
    vegaEmbed('#vis', spec, { actions: false }).then(({ view }) => {
      // 슬라이더 값 표시를 위한 이벤트 리스너
      const minMagEl   = document.getElementById('minMag');
      const maxMagEl   = document.getElementById('maxMag');
      const minValSpan = document.getElementById('minMagValue');
      const maxValSpan = document.getElementById('maxMagValue');

      minMagEl.addEventListener('input', () => minValSpan.textContent = minMagEl.value);
      maxMagEl.addEventListener('input', () => maxValSpan.textContent = maxMagEl.value);
    });
  </script>
</body>
</html>
