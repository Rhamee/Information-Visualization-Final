<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>지진 지도</title>

  <!-- Vega 및 Vega-Embed 불러오기 -->
  <script src="https://cdn.jsdelivr.net/npm/vega@6"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    /* =======================================================
       1) 화면 전체를 Flex 컨테이너로 만들어 중앙 정렬
       ======================================================= */
    html, body {
      margin: 0;
      padding: 0;
      background: #eef2f5;
      display: flex;
      justify-content: center; /* 수평 중앙 정렬 */
      align-items: center;     /* 수직 중앙 정렬 */
      height: 100vh;           /* 화면 전체 높이 확보 */
    }

    /* =======================================================
       2) 지도와 컨트롤을 묶는 래퍼
       ======================================================= */
    .wrapper {
      width: 900px;           /* 지도 너비와 동일 */
      margin: auto;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 16px;             /* 지도 아래 / 컨트롤 위 간격 */
    }

    /* =======================================================
       3) Vega가 렌더링될 영역 (#vis)
       ======================================================= */
    #vis {
      width: 100%;           /* 래퍼 너비(900px)에 딱 맞춤 */
      height: 550px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    /* =======================================================
       4) 검색·필터 컨트롤 박스 (.controls)
       ======================================================= */
    .controls {
      width: 100%;
      background: white;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 12px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    .controls > div {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .controls label {
      font-size: 14px;
      white-space: nowrap;
    }
    .controls input[type="text"] {
      width: 180px;
      padding: 4px 6px;
      font-size: 14px;
    }
    .controls input[type="range"] {
      width: 150px;
    }
    .controls input[type="date"] {
      padding: 4px;
      font-size: 14px;
    }
    .controls span {
      font-size: 14px;
      min-width: 24px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <!-- Vega 지도 렌더링 대상 -->
    <div id="vis"></div>

    <!-- 검색/필터 컨트롤 박스 -->
    <div class="controls">
      <div>
        <label for="searchTerm">위치 검색</label>
        <input type="text" id="searchTerm" placeholder="예: 일본" />
      </div>
      <div>
        <label for="minMag">최소 규모</label>
        <input type="range" id="minMag" min="0" max="10" step="0.1" value="0" />
        <span id="minMagValue">0</span>
      </div>
      <div>
        <label for="maxMag">최대 규모</label>
        <input type="range" id="maxMag" min="0" max="10" step="0.1" value="10" />
        <span id="maxMagValue">10</span>
      </div>
      <div>
        <label for="startDate">시작 날짜</label>
        <input type="date" id="startDate" />
      </div>
      <div>
        <label for="endDate">종료 날짜</label>
        <input type="date" id="endDate" />
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // Vega 스펙: “검색/필터(Signals) + 지도/지진점 함께 줌/팬(Signals)”
    // ============================================================
    const spec = {
      "$schema": "https://vega.github.io/schema/vega/v6.json",
      "width": 900,
      "height": 550,
      "padding": 0,
      "background": "steelblue",

      "signals": [
        // --------------------
        // [A] 검색/필터 시그널
        // --------------------
        {
          "name": "searchTerm",
          "value": "",
          "on": [
            {
              "events": { "source": "view", "type": "signal", "signal": "searchTerm" },
              "update": "searchTerm"
            }
          ]
        },
        {
          "name": "minMag",
          "value": 0,
          "on": [
            {
              "events": { "source": "view", "type": "signal", "signal": "minMag" },
              "update": "minMag"
            }
          ]
        },
        {
          "name": "maxMag",
          "value": 10,
          "on": [
            {
              "events": { "source": "view", "type": "signal", "signal": "maxMag" },
              "update": "maxMag"
            }
          ]
        },
        {
          "name": "startDate",
          "value": "",
          "on": [
            {
              "events": { "source": "view", "type": "signal", "signal": "startDate" },
              "update": "startDate"
            }
          ]
        },
        {
          "name": "endDate",
          "value": "",
          "on": [
            {
              "events": { "source": "view", "type": "signal", "signal": "endDate" },
              "update": "endDate"
            }
          ]
        },

        // --------------------
        // [B] 지도+지진점 줌/팬 전용 시그널
        // --------------------
        {
          "name": "zoom",
          "value": 180,
          "on": [
            {
              "events": "window:wheel!",
              "update": "clamp(zoom * pow(1.001, -event.deltaY), 50, 1200)"
            }
          ]
        },
        {
          "name": "tx",
          "value": 450,
          "on": [
            {
              "events": "window:drag[!event.shiftKey]",
              "update": "tx + event.dx"
            }
          ]
        },
        {
          "name": "ty",
          "value": 275,
          "on": [
            {
              "events": "window:drag[!event.shiftKey]",
              "update": "ty + event.dy"
            }
          ]
        }
      ],

      // =======================================================
      // 프로젝션: zoom, tx, ty 신호를 바인딩하여 동적 계산
      // =======================================================
      "projections": [
        {
          "name": "dynamic_proj",
          "type": "equalEarth",
          "scale": { "signal": "zoom" },
          "translate": [
            { "signal": "tx" },
            { "signal": "ty" }
          ]
        }
      ],

      // =======================================================
      // 데이터: 세계 지도 + 지진 정보
      // =======================================================
      "data": [
        // 1) 세계 지도 (TopoJSON)
        {
          "name": "world",
          "url": "https://vega.github.io/vega/data/world-110m.json",
          "format": { "type": "topojson", "feature": "countries" }
        },
        // 2) 지진 데이터(JSON) → 필터 → geopoint(dynamic_proj) → 면적 계산
        {
          "name": "earthquakes",
          "url": "https://raw.githubusercontent.com/Rhamee/Information-Visualization-Final/main/earthquake_data.json",
          "format": { "type": "json" },
          "transform": [
            // (A) 위치 검색/규모/날짜 필터
            {
              "type": "filter",
              "expr":
                "(searchTerm == '' || indexof(lower(datum.location), lower(searchTerm)) >= 0)" +
                " && (datum.magnitude >= minMag && datum.magnitude <= maxMag)" +
                " && (startDate == '' || datum.date >= startDate)" +
                " && (endDate == '' || datum.date <= endDate)"
            },
            // (B) dynamic_proj 로 x, y 계산 → 줌/팬 시그널 반영되어 업데이트됨
            {
              "type": "geopoint",
              "projection": "dynamic_proj",
              "fields": ["longitude", "latitude"],
              "as": ["x", "y"]
            },
            // (C) 규모 → 원 면적(area) 계산
            {
              "type": "formula",
              "expr": "pow(datum.magnitude, 4) / 3",
              "as": "area"
            }
          ]
        }
      ],

      // =======================================================
      // 마크: (1) 세계 지도(shape) + (2) 지진점(symbol)
      //       모두 dynamic_proj을 사용하여 줌/팬 반영
      // =======================================================
      "marks": [
        // (1) 세계 지도: dynamic_proj 적용
        {
          "type": "shape",
          "from": { "data": "world" },
          "encode": {
            "enter": {
              "fill":   { "value": "seagreen" },
              "stroke": { "value": "#666" }
            }
          },
          "transform": [
            { "type": "geoshape", "projection": "dynamic_proj" }
          ]
        },
        // (2) 지진점: dynamic_proj을 사용해 x, y가 매번 재계산됨
        {
          "type": "symbol",
          "from": { "data": "earthquakes" },
          "encode": {
            "enter": {
              "x":           { "field": "x" },          // dynamic_proj
              "y":           { "field": "y" },          // dynamic_proj
              "size":        { "field": "area" },
              "fill":        { "value": "orange" },
              "stroke":      { "value": "orange" },
              "strokeWidth": { "value": 1 },
              "opacity":     { "value": 0.6 },
              "tooltip": {
                "signal":
                  "'📍 ' + datum.location + '\\n규모: ' + datum.magnitude + ' / ' + datum.date"
              }
            }
          }
        }
      ]
    };

    // =======================================================
    // Vega-Embed: #vis에 spec 렌더링 (actions: false로 버튼 숨김)
    // =======================================================
    vegaEmbed('#vis', spec, { actions: false }).then(({ view }) => {
      // -------------------------------
      // (A) HTML 컨트롤 → Vega 시그널 연결
      // -------------------------------
      const searchEl    = document.getElementById('searchTerm');
      const minMagEl    = document.getElementById('minMag');
      const maxMagEl    = document.getElementById('maxMag');
      const startDateEl = document.getElementById('startDate');
      const endDateEl   = document.getElementById('endDate');
      const minValSpan  = document.getElementById('minMagValue');
      const maxValSpan  = document.getElementById('maxMagValue');

      // 위치 검색
      searchEl.addEventListener('input', () => {
        view.signal('searchTerm', searchEl.value).runAsync();
      });
      // 최소 규모
      minMagEl.addEventListener('input', () => {
        minValSpan.textContent = minMagEl.value;
        view.signal('minMag', +minMagEl.value).runAsync();
      });
      // 최대 규모
      maxMagEl.addEventListener('input', () => {
        maxValSpan.textContent = maxMagEl.value;
        view.signal('maxMag', +maxMagEl.value).runAsync();
      });
      // 시작 날짜
      startDateEl.addEventListener('input', () => {
        view.signal('startDate', startDateEl.value).runAsync();
      });
      // 종료 날짜
      endDateEl.addEventListener('input', () => {
        view.signal('endDate', endDateEl.value).runAsync();
      });

      // -------------------------------
      // (B) 줌/팬은 Vega 내부에서 이미 window 이벤트로 binding했으므로
      //      별도 추가 코드는 필요 없습니다.
      // -------------------------------
    }).catch(console.error);
  </script>
</body>
</html>
